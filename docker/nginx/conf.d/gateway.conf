upstream orionld_upstream {
    server orion-ld:1026;
}

server {
    listen 80;
    server_name _;

    location / {
        access_by_lua_block {
            local remote_ip = ngx.var.remote_addr
            local trusted_ips_str = os.getenv("TRUSTED_IPS") or ""
            local auth_enabled = os.getenv("AUTHENTICATION_ENABLED") or "true"
            local method = ngx.req.get_method()

            ngx.log(ngx.INFO, "[ACCESS] remote_ip=", remote_ip,
                              " method=", method,
                              " auth_enabled=", auth_enabled)

            -- Helper function: check if IP is in trusted list
            local function is_trusted_ip(ip)
                if trusted_ips_str == "" then
                    return false
                end
                -- Split by comma and trim whitespace
                for trusted_ip in string.gmatch(trusted_ips_str, "([^,]+)") do
                    trusted_ip = trusted_ip:match("^%s*(.-)%s*$")  -- trim
                    if ip == trusted_ip then
                        return true
                    end
                end
                return false
            end

            local is_trusted = is_trusted_ip(remote_ip)

            ngx.log(ngx.INFO, "[ACCESS] is_trusted=", tostring(is_trusted))

            -- Logic mới:
            -- 1) GET: Cho phép tất cả mọi người (không cần xác thực)
            if method == "GET" then
                ngx.log(ngx.INFO, "[ACCESS] GET allowed for all")
                return
            end

            -- 2) POST/DELETE: Chỉ Trusted IPs được phép
            if method == "POST" or method == "DELETE" then
                if is_trusted then
                    ngx.log(ngx.INFO, "[ACCESS] POST/DELETE allowed for trusted IP")
                    return
                else
                    ngx.log(ngx.WARN, "[ACCESS] POST/DELETE denied - not trusted IP")
                    ngx.status = ngx.HTTP_FORBIDDEN
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"forbidden","reason":"POST/DELETE only allowed for trusted IPs"}')
                    return ngx.exit(ngx.HTTP_FORBIDDEN)
                end
            end

            -- 3) PATCH/PUT: Trusted IPs luôn được phép, Non-trusted cần JWT (nếu bật auth)
            if method == "PATCH" or method == "PUT" then
                if is_trusted then
                    ngx.log(ngx.INFO, "[ACCESS] PATCH/PUT allowed for trusted IP")
                    return
                end

                -- Non-trusted IP: Kiểm tra authentication enabled
                if auth_enabled == "false" then
                    ngx.log(ngx.INFO, "[ACCESS] PATCH/PUT allowed - authentication disabled")
                    return
                end

                -- Authentication enabled: Yêu cầu JWT
                ngx.log(ngx.INFO, "[ACCESS] PATCH/PUT requires JWT for non-trusted IP")
                local jwt_verify = require "jwt_verify"
                local ok, err = jwt_verify.verify_hs256()
                if not ok then
                    ngx.log(ngx.WARN, "[ACCESS] JWT verification failed: ", err or "unknown")
                    ngx.status = ngx.HTTP_UNAUTHORIZED
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error":"unauthorized","reason":"' .. (err or "invalid JWT") .. '"}')
                    return ngx.exit(ngx.HTTP_UNAUTHORIZED)
                end
                ngx.log(ngx.INFO, "[ACCESS] PATCH/PUT allowed with valid JWT")
                return
            end

            -- 4) Các method khác: Deny
            ngx.log(ngx.WARN, "[ACCESS] Method not allowed: ", method)
            ngx.status = ngx.HTTP_METHOD_NOT_ALLOWED
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error":"method_not_allowed","reason":"Method ' .. method .. ' is not supported"}')
            return ngx.exit(ngx.HTTP_METHOD_NOT_ALLOWED)
        }

        proxy_pass http://orionld_upstream;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
