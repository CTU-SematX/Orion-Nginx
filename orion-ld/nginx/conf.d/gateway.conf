upstream orionld_upstream {
    server orion-ld:1026;
}

server {
    listen 80;
    server_name _;

    location / {
        access_by_lua_block {
            local remote_ip = ngx.var.remote_addr
            local trusted_ip = os.getenv("TRUSTED_IP")
            local method = ngx.req.get_method()

            ngx.log(ngx.ERR, "[DEBUG] remote_ip=", remote_ip,
                            " trusted_ip=", trusted_ip,
                            " method=", method)

            -- 1) IP trusted: bypass mọi thứ
            if trusted_ip and trusted_ip ~= "" and remote_ip == trusted_ip then
                return
            end

            -- 2) IP không trusted + POST -> chặn luôn
            if method == "POST" or method == "GET" or method == "DELETE" then
                ngx.status = ngx.HTTP_FORBIDDEN
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"forbidden","reason":"POST not allowed from this IP"}')
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            -- 3) Các method khác (GET/PUT/...) với IP không trusted -> bắt buộc JWT
            local jwt_verify = require "jwt_verify"
            local ok, err = jwt_verify.verify_hs256()
            if not ok then
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"unauthorized","reason":"' .. (err or "invalid") .. '"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end
        }

        proxy_pass http://orionld_upstream;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
